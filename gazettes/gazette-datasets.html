---
layout: layout.njk
---
<div class="container">
  <div id="gazette-search-tool"></div>
</div>

<script>
  (function ($) {
    // Global variables
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
    const typeOfGazette = {
        "Gazette": "Gazettes",
        "Extraordinary": "Extraordinary gazettes",
        "Index": "Index listings"
    }

    // Search widget config
    let options = {
      dataSources: [
        {
          url: 'https://www.publications.qld.gov.au/api/3/action/package_search?fq=tags:(Gazettes OR gazettes)&rows=1000',
          results: 'result.results'
        },
      ],
      dataCallback: (data) => {
        data.forEach(set => {
          let dateRegex = /(\w+) (\d{4})$/
          let displayDateRegex = /(\d+) (\w+) (\d{4})/
          let volRegex = /(?:Volumes?.*?|Vol\. No\.) (\d+)/i
          let numRegex = /gazettes?(?: No\.)? (\d+[-–]?\d+)/i
          let pageRegex = /\(pages? (\d+[-–]?\d+)/
          let companionGuideRegex = /Companion Guide/

          // Month and Year properties
          let regexMonth = set.title.match(dateRegex)[1]
          let regexYear = set.title.match(dateRegex)[2]

          set.month = ""
          if (months.includes(regexMonth)) {
            set.month = regexMonth
          }
          set.year = regexYear

          set.resources.forEach(resource => {
            // Companion guide boolean property
            let regexCompanionGuide = companionGuideRegex.test(resource.description)
            if (regexCompanionGuide) {
              resource.companionGuide = true
            } else {
              resource.companionGuide = false
            }

            // Page property
            let regexPage = resource.description.match(pageRegex)
            if (regexPage && regexPage.length > 1) {
              resource.page = regexPage[1]
            }
            else {
              resource.page = null
            }

            // No. property
            let regexNum = resource.description.match(numRegex)
            if (regexNum && regexNum.length > 1) {
              resource.number = regexNum[1]
            }
            else {
              resource.number = null
            }

            // Volume property
            let regexVol = resource.description.match(volRegex)
            if (regexVol && regexVol.length > 1) {
              resource.volume = regexVol[1]
            }
            else {
              resource.volume = null
            }

            // Date property
            let regexDate = resource.description.match(displayDateRegex)
            if (regexDate && regexDate.length > 1) {
              resource.date = regexDate[0]
            }
            else {
              resource.date = null
            }
          })

          set.volumes = set.resources
            .map(resource => resource.volume)
            .filter((volume, i, array) => !!volume && i == array.indexOf(volume))
            .join()

          let tagArray = ["Extraordinary", "Index"]
          for (const tag in set.tags) {
            set.gazetteType = `Gazette`
            let tagName = set.tags[tag].name

            if (tagArray.includes(searchTool.helpers.toTitleCase(tagName))) {
              set.gazetteType = searchTool.helpers.toTitleCase(tagName)
              break
            }
          }
        });

        return data
      },
      resultTemplate: {
        data: function (results) {
          return results.map(function (entry) {
            return {
              name: entry.title,
              organization: entry.organization,
              editions: entry.resources,
              tags: entry.tags,
              type: entry.gazetteType
            }
          });
        },
        markup: function (result) {
          let editions_list = result.editions.map(edition => {
            let prelink = edition.date ? edition.date : edition.name
            if (result.type === "Index") {
              if (edition.companionGuide) {
                return `<li><a href="${edition.url}">${edition.name}</a></li>`
              }
              else {
                prelink = edition.name
              }
            }
            return `<li>${prelink} <a href="${edition.url}">
            ${edition.volume ? `Volume ${edition.volume}` : ""} ${edition.number ? `Gazette No. ${edition.number}` : ""} ${edition.page ? `Pages ${edition.page}` : ""}</a></li>`
          }
          )
          editions_list = editions_list.join('')

          let tags_list = result.tags.map(tag => {
            return `${tag.display_name}`
          }
          )
          tags_list = tags_list.join(', ')

          return `
        <div class="card qg-card qg-card__light-theme col-12 mb-4">
          <div class="content">
            <div class="details">
              <h3 class="card-title">${result.name}</h3>
                <div class="card-text">
                  <ul>${editions_list}</ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        `;
        }
      },
      keywords: false,
      keywordFields: [
        "title",
        "description",
        "name"
      ],
      filterFields: {
        year: {
          type: 'select',
          sort: 'reverse',
          multi: true,
          label: "Year"
        },
        month: {
          options: months,
          type: 'select',
          sort: false,
          multi: true,
          label: "Month"
        },
        gazetteType: {
          options: typeOfGazette,
          type: 'select',
          multi: true,
          label: "Gazette type",
          defaultText: "gazette type"
        },
        volumes: {
          type: 'select',
          multi: true,
          label: "Volume",
          defaultText: "volume",
          data: {
            type: 'array',
            separator: ','
          },
          sort: 'numeric'
        }
      },
      sortFields: ['-year'],
      pagination: { // Configuration options for pagination.js.
        pageSize: 20,
      },
    }
    let searchTool = $('#gazette-search-tool').searchTool(options);
  })(jQuery);
</script>
